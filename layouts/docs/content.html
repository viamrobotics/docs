<div class="td-content">
	<!-- Check size of preview images -->
	{{ if .Params.Images }}
		{{ range .Params.Images}}
			{{ $image_ext := path.Ext . }}
			{{if eq $image_ext ".gif" }}
				<!-- GIF -->
				{{if os.FileExists (printf "/static%s" .) }}
					{{ $f := os.Stat (printf "/static%s" .) }}
					{{ $sizeInBytes := div $f.Size 1000 }}
					{{ if gt $sizeInBytes 1000 }}
						{{ errorf "Size of preview file %s was %d kB - please reduce file size" . $sizeInBytes  }}
					{{ end }}
				{{else}}
					{{ errorf "Preview file not found - did you use the absolute file path? %s" . }}
				{{end}}
			{{ else }}
			<!-- it's an image -->
			{{if os.FileExists (printf "/assets%s" .) }}
				{{ $f := os.Stat (printf "/assets%s" .) }}
				{{ $sizeInBytes := div $f.Size 1000 }}
				{{ if gt $sizeInBytes 1000 }}
					{{ errorf "Size of preview file %s was %d kB - please reduce file size" . $sizeInBytes  }}
				{{ end }}
				{{else}}
					{{ errorf "Preview file not found - did you use the absolute file path? %s" . }}
				{{end}}
			{{ end }}
		{{ end }}
	{{ end }}
	<!-- <header class="article-meta">
		{{ partial "taxonomy_terms_article_wrapper.html" . }}
		{{ if (and (not .Params.hide_readingtime) (.Site.Params.ui.readingtime.enable)) }}
			{{ partial "reading-time.html" . }}
		{{ end }}
	</header> -->
	{{ if and (not .IsHome) (not .Params.noTitle) }}
	<h1>{{ .Title }}</h1>
	{{ end }}

	{{ if .Draft }}
	<div class="alert alert-caution" role="alert">
		<h4 class="alert-heading">DRAFT</h4>
		<p>This page is a draft and not visible in the published documentation.</p>
	</div>
	{{ end }}

	{{ .Content }}

	<button class="docsbutton" id="chatButton" title="Chatbot and support">
		<span id="chatButtonContent">
			<i style="font-size:x-large;" class="fas fa-comments"></i>
			<span>Ask AI</span>
		</span>
	</button>
	<button onclick="toTop()" class="docsbutton" id="scrollButton" title="Go to top" style="visibility: hidden;">
	<i style="font-size:x-large;" class="fas fa-chevron-up"></i>
	</button>

	{{ if ne .Params.no_list true}}
	{{ $pages := union .Sections .Pages }}
	<div id="next-page" class="card-container">
	<hr>

	<!-- Build a flat list of all pages respecting hierarchical structure and weights -->
	{{ $allPages := slice }}

	<!-- Collect pages from all top-level sections in order -->
	{{ range .Site.Sections }}
		<!-- Process each top-level section -->
		{{ range .Pages.ByWeight }}
			{{ if eq .Params.layout "empty" }}
				<!-- If this is an empty page, include its subpages recursively -->
				{{ range .Pages.ByWeight }}
					{{ if and (ne .Params.layout "empty") (not .Params.toc_hide) }}
						{{ $allPages = $allPages | append . }}
					{{ end }}
					<!-- Process third level pages -->
					{{ if .Pages }}
						{{ range .Pages.ByWeight }}
							{{ if and (ne .Params.layout "empty") (not .Params.toc_hide) (ne .Params.no_list true) }}
								{{ $allPages = $allPages | append . }}
							{{ end }}
							<!-- Process fourth level pages -->
							{{ if .Pages }}
								{{ range .Pages.ByWeight }}
									{{ if and (ne .Params.layout "empty") (not .Params.toc_hide) (ne .Params.no_list true) }}
										{{ $allPages = $allPages | append . }}
									{{ end }}
									<!-- Process fifth level pages -->
									{{ if .Pages }}
										{{ range .Pages.ByWeight }}
											{{ if and (ne .Params.layout "empty") (not .Params.toc_hide) (ne .Params.no_list true) }}
												{{ $allPages = $allPages | append . }}
											{{ end }}
										{{ end }}
									{{ end }}
								{{ end }}
							{{ end }}
						{{ end }}
					{{ end }}
				{{ end }}
			{{ else }}
				<!-- If this is not an empty page, include it if it's not hidden -->
				{{ if and (not .Params.toc_hide) (ne .Params.no_list true) (ne .Kind "section") }}
					{{ $allPages = $allPages | append . }}
				{{ end }}
				<!-- Also include its subpages recursively if it has any -->
				{{ if .Pages }}
					{{ range .Pages.ByWeight }}
						{{ if and (ne .Params.layout "empty") (not .Params.toc_hide) (ne .Params.no_list true) }}
							{{ $allPages = $allPages | append . }}
						{{ end }}
						<!-- Process third level pages -->
						{{ if .Pages }}
							{{ range .Pages.ByWeight }}
								{{ if and (ne .Params.layout "empty") (not .Params.toc_hide) (ne .Params.no_list true) }}
									{{ $allPages = $allPages | append . }}
								{{ end }}
								<!-- Process fourth level pages -->
								{{ if .Pages }}
									{{ range .Pages.ByWeight }}
										{{ if and (ne .Params.layout "empty") (not .Params.toc_hide) (ne .Params.no_list true) }}
											{{ $allPages = $allPages | append . }}
										{{ end }}
										<!-- Process fifth level pages -->
										{{ if .Pages }}
											{{ range .Pages.ByWeight }}
												{{ if and (ne .Params.layout "empty") (not .Params.toc_hide) (ne .Params.no_list true) }}
													{{ $allPages = $allPages | append . }}
												{{ end }}
											{{ end }}
										{{ end }}
									{{ end }}
								{{ end }}
							{{ end }}
						{{ end }}
					{{ end }}
				{{ end }}
			{{ end }}
		{{ end }}
	{{ end }}

	<!-- log the allPages -->
	{{ warnf "--------------------------------" }}
	{{ range $allPages }}
		{{ warnf "allPages: %s - %s" .Title .RelPermalink }}
	{{ end }}
	{{ warnf "--------------------------------" }}

	<!-- Find next and previous pages from filtered list -->
	{{ $nextPage := false }}
	{{ $prevPage := false }}
	{{ $currentPage := . }}
	{{ range $i, $pageIterator := $allPages }}
		{{ if eq $pageIterator $currentPage }}
			{{ if lt $i (sub (len $allPages) 1) }}
				{{ $nextPage = index $allPages (add $i 1) }}
			{{ end }}
			{{ if gt $i 0 }}
				{{ $prevPage = index $allPages (sub $i 1) }}
			{{ end }}
		{{ end }}
	{{ end }}


	<!-- These are swapped in order -->
	{{ if or $nextPage .Params.next }}
	<div class="row-no-margin">
	{{ else }}
	<div class="row-no-margin {{ if not .Params.prev }}right-only{{ end }}">
	{{ end }}

	{{ if .Params.prev }}
		{{ partial "nextcard.html" (dict "link" (.Params.prev) "class" "left"  "customCanonicalLink" (.Page.Params.canonical) ) }}
	{{ else }}
		{{ with $prevPage }}
			{{ partial "nextcard.html" (dict "link" (.Page.File.Path) "class" "left"  "customCanonicalLink" (.Page.Params.canonical) ) }}
		{{ end }}
	{{ end }}

	{{ if .Params.next }}
		{{ partial "nextcard.html" (dict "link" (.Params.next) "class" "right"  "customCanonicalLink" (.Page.Params.canonical) ) }}
	{{ else }}
		{{ with $nextPage }}
			{{ partial "nextcard.html" (dict "link" (.Page.File.Path) "class" "right"  "customCanonicalLink" (.Page.Params.canonical) ) }}
		{{ end }}
	{{ end }}
	</div>
	</div>
	{{ end }}

	{{ if (.Site.Params.DisqusShortname) }}
		<br />
		{{ partial "disqus-comment.html" . }}
	{{ end }}
	{{ partial "page-meta-lastmod.html" . }}
	{{- if hugo.IsProduction -}}{{ if (and (not .Params.hide_feedback) (.Site.Params.ui.feedback.enable) (.Site.Config.Services.GoogleAnalytics.ID)) }}
		{{ partial "feedback.html" . }}
		<br />
	{{ end }}{{- end -}}
</div>

{{ partial "footer.html" . }}
